#!/bin/bash
#
# pre-push hook: Full quality validation before push
# - Frontend: lint (strict), tests, build
# - Backend: Spotless check, tests (unit + integration)
#
# Environment variables:
#   SKIP_HOOKS=1 - Bypass all checks (emergency only)
#

set -e

if [ "$SKIP_HOOKS" = "1" ]; then
    echo "[pre-push] SKIP_HOOKS=1 - bypassing all checks (use sparingly!)"
    exit 0
fi

REPO_ROOT="$(git rev-parse --show-toplevel)"
FRONTEND_DIR="$REPO_ROOT/frontend"
BACKEND_DIR="$REPO_ROOT/backend"

FAILED=0

echo "=============================================="
echo "[pre-push] Running full quality validation..."
echo "=============================================="
echo ""

# Frontend checks
if [ -d "$FRONTEND_DIR" ] && [ -f "$FRONTEND_DIR/package.json" ]; then
    echo "[pre-push] === Frontend ==="
    cd "$FRONTEND_DIR"

    echo "[pre-push] Running lint (strict mode - 0 warnings allowed)..."
    if ! pnpm lint --max-warnings 0; then
        echo ""
        echo "ERROR: Frontend lint failed or has warnings."
        FAILED=1
    fi

    echo "[pre-push] Running tests..."
    if ! pnpm test --run; then
        echo ""
        echo "ERROR: Frontend tests failed."
        FAILED=1
    fi

    echo "[pre-push] Running build..."
    if ! pnpm build; then
        echo ""
        echo "ERROR: Frontend build failed."
        FAILED=1
    fi

    if [ $FAILED -eq 0 ]; then
        echo "[pre-push] Frontend checks passed."
    fi

    cd "$REPO_ROOT"
    echo ""
fi

# Backend checks
if [ -d "$BACKEND_DIR" ] && [ -f "$BACKEND_DIR/pom.xml" ]; then
    echo "[pre-push] === Backend ==="
    cd "$BACKEND_DIR"

    echo "[pre-push] Running Spotless check..."
    if ! ./mvnw -q spotless:check; then
        echo ""
        echo "ERROR: Backend code formatting issues found."
        echo "Run: cd backend && ./mvnw spotless:apply"
        FAILED=1
    fi

    echo "[pre-push] Running tests (unit + integration)..."
    if ! ./mvnw -q verify -Dspotless.check.skip=true; then
        echo ""
        echo "ERROR: Backend tests failed."
        FAILED=1
    else
        echo "[pre-push] Backend checks passed."
    fi

    cd "$REPO_ROOT"
    echo ""
fi

# Final result
echo "=============================================="
if [ $FAILED -eq 1 ]; then
    echo "[pre-push] BLOCKED - Fix issues above before pushing."
    echo ""
    echo "To bypass (emergency only): SKIP_HOOKS=1 git push ..."
    exit 1
fi

echo "[pre-push] All checks passed! Push proceeding..."
exit 0