#!/usr/bin/env bash
#
# pre-commit hook: Fast quality checks before commit
# - Frontend: ESLint with --max-warnings 0 (strict mode)
# - Backend: Spotless format check
#
# Set SKIP_HOOKS=1 to bypass (emergency only)
#

set -e

if [ "$SKIP_HOOKS" = "1" ]; then
    echo "[pre-commit] SKIP_HOOKS=1 - bypassing checks (use sparingly!)"
    exit 0
fi

REPO_ROOT="$(git rev-parse --show-toplevel)"
FRONTEND_DIR="$REPO_ROOT/frontend"
BACKEND_DIR="$REPO_ROOT/backend"

# Track if we have any failures
FAILED=0

echo "[pre-commit] Running quality checks..."
echo ""

# Get staged files to determine what to check
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Check if any frontend files are staged
FRONTEND_STAGED=$(echo "$STAGED_FILES" | grep -E "^frontend/" || true)
# Check if any backend files are staged
BACKEND_STAGED=$(echo "$STAGED_FILES" | grep -E "^backend/" || true)

# Frontend checks
if [ -n "$FRONTEND_STAGED" ] && [ -d "$FRONTEND_DIR" ]; then
    echo "[pre-commit] Frontend files staged - running lint (strict mode)..."
    cd "$FRONTEND_DIR"

    if ! pnpm lint --max-warnings 0; then
        echo ""
        echo "ERROR: Frontend lint failed or has warnings."
        echo "Fix all ESLint errors AND warnings before committing."
        echo "Run: cd frontend && pnpm lint:fix"
        echo ""
        FAILED=1
    else
        echo "[pre-commit] Frontend lint passed (0 warnings, 0 errors)"
    fi

    cd "$REPO_ROOT"
fi

# Backend checks - Spotless format check
if [ -n "$BACKEND_STAGED" ] && [ -d "$BACKEND_DIR" ]; then
    echo "[pre-commit] Backend files staged - running Spotless check..."
    cd "$BACKEND_DIR"

    if ! ./mvnw -q spotless:check; then
        echo ""
        echo "ERROR: Backend code formatting issues found."
        echo "Run: cd backend && ./mvnw spotless:apply"
        echo ""
        FAILED=1
    else
        echo "[pre-commit] Backend Spotless check passed"
    fi

    cd "$REPO_ROOT"
fi

if [ $FAILED -eq 1 ]; then
    echo ""
    echo "[pre-commit] BLOCKED - Fix the issues above before committing."
    echo "To bypass (emergency only): SKIP_HOOKS=1 git commit ..."
    exit 1
fi

echo ""
echo "[pre-commit] All checks passed!"
exit 0